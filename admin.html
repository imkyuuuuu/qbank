<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin - Gestion des R√©ponses</title>
  
  <script>
    if (sessionStorage.getItem('auth_token') !== 'connected') {
      window.location.href = 'login.html';
    }
  </script>

  <style>
    /* --- TH√àME DEEP NIGHT --- */
    :root { 
      --bg: #0b1021; --card: #161c33; 
      --blue: #4dabf7; --text: #e9ecf5; 
      --green: #2ecc71; --red: #e74c3c; --yellow: #f1c40f;
      --border: rgba(255,255,255,0.1); 
    }
    
    body { background: var(--bg); color: var(--text); font-family: sans-serif; padding: 20px; }
    .container { max-width: 900px; margin: 0 auto; }
    
    h1 { color: var(--blue); border-bottom: 1px solid var(--border); padding-bottom: 15px; }

    .filter-bar { margin: 20px 0; display: flex; gap: 10px; }
    select { padding: 12px; background: var(--card); color: white; border: 1px solid var(--border); border-radius: 8px; flex-grow: 1; font-size: 16px; cursor: pointer; }
    option { background: var(--card); color: white; }

    /* Carte Question */
    .q-card { 
      background: var(--card); border: 1px solid var(--border); 
      padding: 20px; margin-bottom: 20px; border-radius: 12px; 
      position: relative;
    }
    
    /* Indicateurs */
    .q-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 12px; font-weight: bold; color: var(--blue); }
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; margin-left: 10px; }
    .badge-mod { background: rgba(241, 196, 15, 0.2); color: var(--yellow); border: 1px solid var(--yellow); }
    .badge-alert { background: rgba(231, 76, 60, 0.2); color: var(--red); border: 1px solid var(--red); }

    .q-stem { font-weight: 600; font-size: 1.1em; margin-bottom: 15px; line-height: 1.5; }
    
    /* Choix */
    .choice { 
      padding: 12px; margin: 8px 0; border: 1px solid var(--border); border-radius: 8px; 
      cursor: pointer; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center;
    }
    .choice:hover { background: rgba(255,255,255,0.05); border-color: var(--blue); }
    
    /* √âtats des choix */
    .is-correct { border-color: var(--green); background: rgba(46, 204, 113, 0.15); color: var(--green); font-weight: bold; }
    
    /* Zone de signalement */
    .report-box {
      background: rgba(231, 76, 60, 0.1); border-left: 4px solid var(--red);
      padding: 15px; margin-bottom: 15px; border-radius: 4px;
    }
    .report-item { 
      display: flex; justify-content: space-between; align-items: flex-start; 
      margin-bottom: 8px; font-size: 0.9em; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 8px;
    }
    .btn-delete { background: none; border: none; cursor: pointer; font-size: 16px; opacity: 0.7; }
    .btn-delete:hover { opacity: 1; transform: scale(1.1); }

    /* Bouton retour */
    .btn-home {
      display: inline-block; text-decoration: none; color: var(--text); 
      background: var(--card); border: 1px solid var(--border); 
      padding: 8px 16px; border-radius: 6px; font-size: 14px; margin-bottom: 20px;
    }
  </style>
</head>
<body>

<div class="container">
  <a href="index.html" class="btn-home">‚Üê Retour au Quiz</a>
  
  <h1>üïµÔ∏è‚Äç‚ôÇÔ∏è Console d'Administration</h1>
  
  <div class="filter-bar">
    <select id="bankSelector"><option value="">Chargement...</option></select>
  </div>
  
  <div id="questionsList"></div>
</div>

<script src="./banks/bank-2021.js"></script>
<script src="./banks/bank-2022.js"></script>
<script src="./banks/bank-2023.js"></script>
<script src="./banks/bank-2024.js"></script>
<script src="./banks/bank-2025.js"></script>
<script src="./banks/bank-CL.js"></script>
<script src="./banks/bank-TP.js"></script>
<script src="./banks/bank-TUS.js"></script>
<script src="./banks/bank-alimentaire.js"></script>
<script src="./banks/bank-anxiete.js"></script>
<script src="./banks/bank-cope.js"></script>
<script src="./banks/bank-depression.js"></script>
<script src="./banks/bank-epidemio.js"></script>
<script src="./banks/bank-geronto.js"></script>
<script src="./banks/bank-legal.js"></script>
<script src="./banks/bank-mab.js"></script>
<script src="./banks/bank-pedopsy.js"></script>
<script src="./banks/bank-perinat.js"></script>
<script src="./banks/bank-pharmatothx.js"></script>
<script src="./banks/bank-psychose.js"></script>
<script src="./banks/bank-psychotherapie.js"></script>
<script src="./banks/bank-sommeil.js"></script>
<script src="./banks/bank-usa6.js"></script>
<script src="./banks/bank-usa5.js"></script>
<script src="./banks/bank-cope-2025.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, setDoc, getDocs, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // --- CONFIGURATION FIREBASE ---
  const firebaseConfig = {
    apiKey: "AIzaSyAYVxT8Le90OB0XFfqxinI1bYnwWBMqAGY",
    authDomain: "qbank-c06a6.firebaseapp.com",
    projectId: "qbank-c06a6",
    storageBucket: "qbank-c06a6.firebasestorage.app",
    messagingSenderId: "872766547331",
    appId: "1:872766547331:web:bd270985956702c99142b6",
    measurementId: "G-KBMXFQ96HH"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Variables
  const banks = window.QUIZ_BANKS || {};
  let correctionsMap = {};
  let reportsMap = {};

  // D√©marrage
  async function init() {
    await Promise.all([loadCorrections(), loadReports()]);
    initUI();
  }

  // 1. Charger les corrections (R√©ponses modifi√©es)
  async function loadCorrections() {
    try {
      const snapshot = await getDocs(collection(db, "corrections"));
      snapshot.forEach(doc => {
        correctionsMap[doc.id] = doc.data().answerIndex;
      });
    } catch (e) { console.error("Erreur corrections:", e); }
  }

  // 2. Charger les signalements (Plaintes utilisateurs)
  async function loadReports() {
    try {
      const snapshot = await getDocs(collection(db, "reports"));
      snapshot.forEach(doc => {
        const data = doc.data();
        const qId = data.questionId;
        
        if (!reportsMap[qId]) reportsMap[qId] = [];
        reportsMap[qId].push({ 
          id: doc.id, 
          reason: data.reason, 
          date: data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleDateString() : '?' 
        });
      });
    } catch (e) { console.error("Erreur signalements:", e); }
  }

  // 3. Initialiser l'interface
  function initUI() {
    const selector = document.getElementById("bankSelector");
    
    // Ajout de l'option sp√©ciale "SIGNALEMENTS"
    let options = '<option value="all">Toutes les banques</option>';
    options += '<option value="reported" style="background:#3c1f1f; color:#e74c3c; font-weight:bold;">‚ö†Ô∏è Voir les Signalements</option>';
    options += '<option disabled>------------------------</option>';
    
    // Ajout des banques
    Object.keys(banks).forEach(key => {
      options += `<option value="${key}">${banks[key].label}</option>`;
    });
    
    selector.innerHTML = options;
    selector.addEventListener("change", () => renderQuestions(selector.value));
    
    // Afficher tout par d√©faut
    renderQuestions("all");
  }

  // 4. Afficher les questions
  function renderQuestions(bankKey) {
    const list = document.getElementById("questionsList");
    list.innerHTML = "";

    let questionsToShow = [];
    
    // --- LOGIQUE DE FILTRAGE ---
    if (bankKey === "reported") {
      // Cas sp√©cial : On parcourt TOUT et on garde seulement ceux qui ont des signalements
      Object.values(banks).forEach(b => {
        b.questions.forEach(q => {
          if (reportsMap[q.id] && reportsMap[q.id].length > 0) {
            questionsToShow.push(q);
          }
        });
      });
      
      if (questionsToShow.length === 0) {
        list.innerHTML = "<div style='text-align:center; padding:40px; color:#aaa;'>Aucun signalement en cours. Tout va bien ! üéâ</div>";
        return;
      }

    } else if (bankKey === "all") {
      Object.values(banks).forEach(b => questionsToShow.push(...b.questions));
    } else if (banks[bankKey]) {
      questionsToShow = banks[bankKey].questions;
    }

    // S√©curit√© performance (sauf si on filtre par signalement, on veut tout voir)
    if(bankKey !== "reported" && questionsToShow.length > 600) {
        questionsToShow = questionsToShow.slice(0, 600);
        console.warn("Affichage limit√© pour la performance.");
    }

    questionsToShow.forEach(q => {
      const card = document.createElement("div");
      card.className = "q-card";
      
      // √âtat de la question
      const savedIndex = correctionsMap[q.id];
      const currentIndex = (savedIndex !== undefined) ? savedIndex : q.answerIndex;
      const isModified = (savedIndex !== undefined && savedIndex !== q.answerIndex);
      
      const reports = reportsMap[q.id];
      const hasReports = reports && reports.length > 0;

      // Style sp√©cial si signal√©e
      if (hasReports) card.style.border = "2px solid #e74c3c";

      // En-t√™te de la carte
      let html = `<div class="q-header">
                    <span>ID: ${q.id}</span>
                    <div>
                        ${isModified ? '<span class="badge badge-mod">‚úèÔ∏è MODIFI√â</span>' : ''}
                        ${hasReports ? `<span class="badge badge-alert">‚ö†Ô∏è ${reports.length} SIGNALEMENT(S)</span>` : ''}
                    </div>
                  </div>
                  <div class="q-stem">${q.stem}</div>`;

      // Affichage des plaintes
      if (hasReports) {
        html += `<div class="report-box">
                   <strong style="color:var(--red)">Plaintes utilisateurs :</strong>
                   <div style="margin-top:10px">`;
        reports.forEach(r => {
          html += `<div class="report-item">
                     <span>"${r.reason}" <em style="opacity:0.6; font-size:0.8em">(${r.date})</em></span>
                     <button onclick="window.deleteReport('${r.id}', this)" class="btn-delete" title="Supprimer le signalement">üóëÔ∏è</button>
                   </div>`;
        });
        html += `</div></div>`;
      }

      // Affichage des choix
      q.choices.forEach((choice, idx) => {
        const isSelected = (idx === currentIndex);
        const safeId = q.id.replace(/'/g, "\\'"); 
        
        html += `<div class="choice ${isSelected ? 'is-correct' : ''}" 
                      onclick="window.updateAnswer('${safeId}', ${idx}, this)">
                   <span>${String.fromCharCode(65+idx)}. ${choice}</span>
                   ${isSelected ? '<span>‚úÖ</span>' : ''}
                 </div>`;
      });

      card.innerHTML = html;
      list.appendChild(card);
    });
  }

  // 5. Fonction globale : Sauvegarder une correction
  window.updateAnswer = async function(questionId, newIndex, element) {
    if (!confirm("Voulez-vous d√©finir cette r√©ponse comme la nouvelle bonne r√©ponse ?")) return;

    try {
      await setDoc(doc(db, "corrections", questionId), {
        answerIndex: newIndex,
        updatedAt: new Date().toISOString()
      });

      const parent = element.parentElement;
      parent.querySelectorAll('.choice').forEach(el => {
        el.classList.remove('is-correct');
        if(el.lastElementChild && el.lastElementChild.tagName === "SPAN" && el.lastElementChild.innerText === "‚úÖ") {
            el.lastElementChild.remove();
        }
      });
      
      element.classList.add('is-correct');
      const check = document.createElement("span");
      check.innerText = "‚úÖ";
      element.appendChild(check);
      
      const headerDiv = element.closest('.q-card').querySelector('.q-header div');
      if(!headerDiv.querySelector('.badge-mod')) {
          const badge = document.createElement("span");
          badge.className = "badge badge-mod";
          badge.innerText = "‚úèÔ∏è MODIFI√â";
          headerDiv.prepend(badge);
      }

    } catch (e) {
      console.error(e);
      alert("Erreur lors de la sauvegarde : " + e.message);
    }
  };

  // 6. Fonction globale : Supprimer un signalement
  window.deleteReport = async function(reportId, btnElement) {
    if(!confirm("Supprimer ce signalement ?")) return;
    
    try {
      await deleteDoc(doc(db, "reports", reportId));
      
      const item = btnElement.parentElement;
      const box = item.parentElement;
      item.remove();
      
      if(box.children.length === 0) {
          const card = box.closest('.q-card');
          box.parentElement.remove();
          card.style.border = "1px solid var(--border)";
          const badge = card.querySelector('.badge-alert');
          if(badge) badge.remove();
      }
      
    } catch(e) { 
        console.error(e); 
        alert("Erreur suppression.");
    }
  };

  init();
</script>
</body>
</html>
