<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin - Gestion des R√©ponses</title>
  <script>
    // S√©curit√© basique : on v√©rifie si connect√©
    if (sessionStorage.getItem('auth_token') !== 'connected') {
      window.location.href = 'login.html';
    }
  </script>
  <style>
    :root { --bg: #0b1021; --card: #161c33; --blue: #4dabf7; --text: #e9ecf5; --green: #2ecc71; --border: rgba(255,255,255,0.1); }
    body { background: var(--bg); color: var(--text); font-family: sans-serif; padding: 20px; }
    .container { max-width: 800px; margin: 0 auto; }
    
    .filter-bar { margin-bottom: 20px; display: flex; gap: 10px; }
    select { padding: 10px; background: var(--card); color: white; border: 1px solid var(--border); border-radius: 8px; flex-grow: 1;}

    .q-card { background: var(--card); border: 1px solid var(--border); padding: 20px; margin-bottom: 20px; border-radius: 12px; }
    .q-id { color: var(--blue); font-size: 12px; font-weight: bold; margin-bottom: 5px; }
    .q-stem { font-weight: 600; margin-bottom: 15px; }
    
    .choice { 
      padding: 10px; margin: 5px 0; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; transition: all 0.2s; 
      display: flex; justify-content: space-between; align-items: center;
    }
    .choice:hover { background: rgba(255,255,255,0.05); }
    
    /* Styles pour les √©tats */
    .is-correct { border-color: var(--green); background: rgba(46, 204, 113, 0.1); color: var(--green); font-weight: bold; }
    .is-overridden { border-left: 4px solid #f1c40f; } /* Indicateur visuel qu'une correction est active */

    button.save-btn { background: var(--blue); color: #000; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-top: 10px;}
  </style>
</head>
<body>

<div class="container">
  <h1>üïµÔ∏è‚Äç‚ôÇÔ∏è Page Secr√®te - Modification des R√©ponses</h1>
  <div class="filter-bar">
    <select id="bankSelector"><option value="">Chargement des banques...</option></select>
  </div>
  <div id="questionsList"></div>
</div>

<script src="./banks/bank-2021.js"></script>
<script src="./banks/bank-2022.js"></script>
<script src="./banks/bank-2023.js"></script>
<script src="./banks/bank-2024.js"></script>
<script src="./banks/bank-2025.js"></script>
<script src="./banks/bank-CL.js"></script>
<script src="./banks/bank-TP.js"></script>
<script src="./banks/bank-TUS.js"></script>
<script src="./banks/bank-alimentaire.js"></script>
<script src="./banks/bank-anxiete.js"></script>
<script src="./banks/bank-cope.js"></script>
<script src="./banks/bank-depression.js"></script>
<script src="./banks/bank-epidemio.js"></script>
<script src="./banks/bank-geronto.js"></script>
<script src="./banks/bank-legal.js"></script>
<script src="./banks/bank-mab.js"></script>
<script src="./banks/bank-pedopsy.js"></script>
<script src="./banks/bank-perinat.js"></script>
<script src="./banks/bank-pharmatothx.js"></script>
<script src="./banks/bank-psychose.js"></script>
<script src="./banks/bank-psychotherapie.js"></script>
<script src="./banks/bank-sommeil.js"></script>
<script src="./banks/bank-usa6.js"></script>
<script src="./banks/bank-usa5.js"></script>
<script src="./banks/bank-cope-2025.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, setDoc, getDocs, collection } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // üî¥ COLLEZ VOTRE CONFIGURATION FIREBASE ICI üî¥
  const firebaseConfig = {
  apiKey: "AIzaSyAYVxT8Le90OB0XFfqxinI1bYnwWBMqAGY",
¬† authDomain: "qbank-c06a6.firebaseapp.com",
¬† projectId: "qbank-c06a6",
¬† storageBucket: "qbank-c06a6.firebasestorage.app",
¬† messagingSenderId: "872766547331",
¬† appId: "1:872766547331:web:bd270985956702c99142b6",
¬† measurementId: "G-KBMXFQ96HH"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Variables globales
  const banks = window.QUIZ_BANKS || {};
  let correctionsMap = {}; // Stocke les corrections charg√©es de Firebase

  // 1. Charger les corrections existantes au d√©marrage
  async function loadCorrections() {
    const snapshot = await getDocs(collection(db, "corrections"));
    snapshot.forEach(doc => {
      correctionsMap[doc.id] = doc.data().answerIndex;
    });
    initUI();
  }

  // 2. Initialiser l'interface
  function initUI() {
    const selector = document.getElementById("bankSelector");
    selector.innerHTML = '<option value="all">Toutes les banques</option>';
    
    Object.keys(banks).forEach(key => {
      const opt = document.createElement("option");
      opt.value = key;
      opt.textContent = banks[key].label;
      selector.appendChild(opt);
    });

    selector.addEventListener("change", () => renderQuestions(selector.value));
    renderQuestions("all"); // Charger tout par d√©faut (ou la premi√®re)
  }

  // 3. Afficher les questions
  function renderQuestions(bankKey) {
    const list = document.getElementById("questionsList");
    list.innerHTML = "";

    let questionsToShow = [];
    if (bankKey === "all") {
      Object.values(banks).forEach(b => questionsToShow.push(...b.questions));
    } else if (banks[bankKey]) {
      questionsToShow = banks[bankKey].questions;
    }

    // Limiter l'affichage pour √©viter de faire ramer le navigateur si trop de questions
    // On affiche les 50 premi√®res ou on ajoute une pagination simple si besoin
    // Pour l'instant, on affiche tout mais attention √† la performance.
    
    questionsToShow.forEach(q => {
      const card = document.createElement("div");
      card.className = "q-card";
      
      // V√©rifier si une correction existe
      const savedIndex = correctionsMap[q.id];
      const currentIndex = (savedIndex !== undefined) ? savedIndex : q.answerIndex;
      const isModified = (savedIndex !== undefined && savedIndex !== q.answerIndex); // Visuel si modifi√©

      if (isModified) card.classList.add("is-overridden");

      let html = `<div class="q-id">ID: ${q.id} ${isModified ? '‚úèÔ∏è MODIFI√â' : ''}</div>
                  <div class="q-stem">${q.stem}</div>`;

      q.choices.forEach((choice, idx) => {
        const isSelected = (idx === currentIndex);
        html += `<div class="choice ${isSelected ? 'is-correct' : ''}" 
                      onclick="updateAnswer('${q.id}', ${idx}, this)">
                   ${String.fromCharCode(65+idx)}. ${choice}
                   ${isSelected ? '‚úÖ' : ''}
                 </div>`;
      });

      card.innerHTML = html;
      list.appendChild(card);
    });
  }

  // 4. Fonction pour sauvegarder le changement (Globale)
  window.updateAnswer = async function(questionId, newIndex, element) {
    if (!confirm("Voulez-vous d√©finir cette r√©ponse comme la nouvelle bonne r√©ponse ?")) return;

    try {
      // Sauvegarder dans Firestore collection "corrections"
      // ID du document = ID de la question
      await setDoc(doc(db, "corrections", questionId), {
        answerIndex: newIndex,
        updatedAt: new Date().toISOString()
      });

      // Mise √† jour visuelle imm√©diate
      const parent = element.parentElement;
      // Retirer le style correct des autres
      parent.querySelectorAll('.choice').forEach(el => {
        el.classList.remove('is-correct');
        el.innerHTML = el.innerHTML.replace('‚úÖ', '');
      });
      // Ajouter au nouveau
      element.classList.add('is-correct');
      element.innerHTML += ' ‚úÖ';
      
      alert("Correction sauvegard√©e ! Elle sera active pour tous les utilisateurs.");
      
    } catch (e) {
      console.error(e);
      alert("Erreur lors de la sauvegarde.");
    }
  };

  // D√©marrage
  loadCorrections();

</script>
</body>
</html>
